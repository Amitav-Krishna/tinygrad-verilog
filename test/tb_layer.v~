module tb_layer;
  reg clk;
  reg start;

  reg signed [63:0] x_vals;
  reg signed [255:0] w_vals;
  reg signed [63:0] b_vals;

  wire signed [63:0] y;
  wire done;

  layer #(
    .N(4),
    .M(4)
   ) uut (
    .clk(clk),
    .start(start),
    .x_vals(x_vals),
    .w_vals(w_vals),
    .b_vals(b_vals),
    .y(y),
    .done(done)
  );

  always #5 clk = ~clk;

  // ~ is the not operator, which makes clock flip every 5 time units.
  
  // Helper functions
  function real q8_to_real;
      input signed [15:0] q;
      begin
          q8_to_real = $itor(q) / 256.0;
      end
  endfunction

  function signed [15:0] real_to_q8;
      input real r;
      begin
          real_to_q8 = $rtoi(r * 256.0);
      end
  endfunction

  initial begin
    $display("=== Layer Unit Test ===");

    // Initialize vectors (Q8.8 fixed point)
    x_vals = {
      real_to_q8(4.0),
      real_to_q8(3.0),
      real_to_q8(2.0),
      real_to_q8(1.0)
    };

    // Identity weight matrix (each neuron picks one input)
    w_vals = {
      // Neuron 3 weights (w3_3, w3_2, w3_1, w3_0)
      real_to_q8(1.0), real_to_q8(0.0), real_to_q8(0.0), real_to_q8(0.0),
      // Neuron 2 weights
      real_to_q8(0.0), real_to_q8(1.0), real_to_q8(0.0), real_to_q8(0.0),
      // Neuron 1 weights
      real_to_q8(0.0), real_to_q8(0.0), real_to_q8(1.0), real_to_q8(0.0),
      // Neuron 0 weights
      real_to_q8(0.0), real_to_q8(0.0), real_to_q8(0.0), real_to_q8(1.0)
    };

    // Zero biases
    b_vals = {
      real_to_q8(0.0),
      real_to_q8(0.0),
      real_to_q8(0.0),
      real_to_q8(0.0)
    };

    clk = 0;
    start = 0;

    #20;
    start = 1;
    #10;
    start = 0;

    #200;

    $display("Inputs:  [%.3f, %.3f, %.3f, %.3f]",
      q8_to_real(x_vals[15:0]),
      q8_to_real(x_vals[31:16]),
      q8_to_real(x_vals[47:32]),
      q8_to_real(x_vals[63:48]));

    $display("Outputs: [%.3f, %.3f, %.3f, %.3f] (expected identity)",
      q8_to_real(y[15:0]),
      q8_to_real(y[31:16]),
      q8_to_real(y[47:32]),
      q8_to_real(y[63:48]));

    $display("Done: %b", done);
    $finish;
  end
endmodule
  
  /*
  module layer #(
    parameter N = 4,
    parameter M = 4,
  ) (
    input wire clk,
    input wire start,
    input wire signed [(N*16)-1:0] x_vals,
    input wire signed [((M*N)*16)-1:0] w_vals,
    input wire signed [(M*16)-1:0] b_vals,
    output wire signed [(M*16)-1:0] y,
    output wire done
  */
